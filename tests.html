<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>My own little testrunner</title>
        <style>
            body { font-family: monospace; }
            #total-result { font-size: 2em; margin: 1em 0; }
            ul { margin: 0; list-style: none; padding-left: 2.5em; margin-left: -2.5em; }
            form { visibility: hidden; height: 0; }
            .good { color: #1cbf00; }
            .bad {  color: #c00; }
        </style>
        <script>
            window.onerror = function () {
                var errorMsg = document.createElement('div');
                errorMsg.className = 'bad';
                errorMsg.innerHTML = 'Some error happened. Check the console.';


                get('total-result').appendChild(errorMsg);
            }

            function createLi (html, className) {
                var li = document.createElement('li')

                li.innerHTML = html;
                li.className = className;

                return li;
            }

            // Helper functions
            function removeElement (el) {
                el.parentNode.removeChild(el);
            }

            function hasClass (className, el) {
                return !!el.className.match(new RegExp('(\\s|^)'+className+'(\\s|$)'));
            }

            function get (id) {
                return document.getElementById(id);
            }

            var total = 0, passed = 0;

            function expect (expected, msg) {
                var li = createLi(msg, expected === true ? 'good' : 'bad');

                get('results').appendChild(li);

                total++;
                get('total').innerHTML = total;

                passed = expected === true ? passed + 1 : passed;
                get('passed').innerHTML = passed;

                if (passed < total) {
                    get('total-result').className = 'bad';
                }
            }

            function setValue (el, value) {
                el.value = value;
                trigger(el, 'input');
            }

            function isValid (el) {
                return hasClass('nod-success', el.parentNode);
            }

            function isInvalid (el) {
                return hasClass('nod-error', el.parentNode);
            }

            function isUnchecked (el) {
                return !(isValid(el) || isInvalid(el));
            }

            function trigger (el, eventName) {
                var customEvent = new CustomEvent(eventName);
                el.dispatchEvent(customEvent);

                return customEvent;
            }

            var ERROR_MSG = 'some error message';
        </script>
        <script src='nod.js'></script>
    </head>
    <body>


        <div id='total-result' class='good'>
            <span id='passed'>0</span> / <span id='total'>0</span>
        </div>

        <ul id='results'></ul>



        <form action="">
            <input id='a' type='text'>
        </form>

        <script>
            (function () {
                var a_nod = nod();

                // Test that we can add an element, and that 'presence' works as expected.
                a_nod.add({
                    selector: '#a',
                    validate: 'presence',
                    errorMessage: ERROR_MSG
                });

                var a = get('a');

                expect(isUnchecked(a), 'Status in \'unchecked\' before entering anything');

                trigger(a, 'input');

                expect(isUnchecked(a), 'Check delay for unchecked inputs work');

                setTimeout(function () {
                    expect(isInvalid(a), 'Empty is invalid (\'presence\')');

                    setValue(a, 'foo');

                    expect(isValid(a), 'Valid on entering. Also, no delay for this');

                    a_nod.remove(a);

                    setValue(a, '');

                    setTimeout(function () {
                        expect(isUnchecked(a), 'Element is removed');


                        // We're done
                        removeElement(a.parentNode);
                    }, 800);
                }, 800);
            })();
        </script>






        <form action=''>
            <input id='b' type='text'>
            <input id='bb' type='text'>
        </form>

        <script>
            (function () {
                var b_nod = nod();

                b_nod.add({
                    selector: '#bb',
                    validate: 'same-as:#b',
                    errorMessage: ERROR_MSG,
                    triggeredBy: '#b'
                });

                var b  = get('b');
                    bb = get('bb');

                // We will also test removing delay
                b_nod.configure("delay", 0);

                setValue(b, 'foo');

                expect(isInvalid(bb), 'Triggered by should work?');

                setValue(bb, 'foo');

                expect(isValid(bb), 'Same-as works');

                // We're done
                removeElement(b.parentNode);
            })();
        </script>



        <form action=''>
            <input class='c' id='c' type='text'>
            <input class='c' id='cc' type='text'>
        </form>


        <script>
            (function () {
                var c_nod = nod();

                c_nod.add({
                    selector: '.c',
                    validate: 'only-one-of',
                    errorMessage: ERROR_MSG
                });

                var c  = get('c');
                    cc = get('cc');

                setValue(c, 'foo');
                setValue(cc, 'foo');

                setTimeout(function () {
                    expect(isInvalid(c), 'Only-one-of won\'t allow two elements to have input + two elements added with one selector');

                    setValue(cc, '');

                    expect(isValid(c), 'Only-one-of will allow one element to have input');

                    // We're done
                    removeElement(c.parentNode);
                }, 800);
            })();
        </script>




        <form action=''>
            <input id='d' type='text'>
        </form>

        <script>
            (function () {
                var d_nod = nod();

                d_nod.add({
                    selector: '#d',
                    validate: 'exact:foo',
                    errorMessage: ERROR_MSG
                });

                var d  = get('d');

                // Let's test some configuration
                d_nod.configure({
                    delay: 0,
                    successClass: 'success-class',
                    successMessage: 'success msg',
                    successMessageClass: 'success-msg-class',
                    errorClass: 'error-class',
                    errorMessageClass: 'error-msg-class'
                });

                setValue(d, 'foo');

                expect(hasClass('success-class', d.parentNode), 'Changing success class');
                expect(d.parentNode.lastChild.innerHTML === 'success msg', 'Changing success message');
                expect(hasClass('success-msg-class', d.parentNode.lastChild), 'Changing success message class');

                setValue(d, '');

                expect(hasClass('error-class', d.parentNode), 'Changing error class');
                expect(hasClass('error-msg-class', d.parentNode.lastChild), 'Changing error message class');

                // We're done
                removeElement(d.parentNode);
            })();
        </script>


        <form action=''>
            <input id='e' type='text'>
        </form>

        <script>
            (function () {
                var e_nod = nod();

                e_nod.add({
                    selector: '#e',
                    validate: 'not:foo',
                    errorMessage: ERROR_MSG
                });

                var e  = get('e'),
                    ele, val, res;

                e_nod.configure('tap', function (el, validate, result) {
                    ele = el;
                    val = validate;
                    res = result;
                });

                setValue(e, 'foo');

                expect(ele === e, 'First argument in tap fn is the element');
                expect(val === 'not:foo', 'Second argument in tap fn is the `validate` string');
                expect(res === false, 'Third argument in tap fn is the result');

                // We're done
                removeElement(e.parentNode);
            })();
        </script>


        <form action=''>
            <input id='f' type='text'>
            <button type='submit' id='f_btn'>foo</button>
        </form>

        <script>
            (function () {
                var f_nod = nod();

                f_nod.add({
                    selector: '#f',
                    validate: 'max-length:2',
                    errorMessage: ERROR_MSG
                });

                var f  = get('f'),
                    f_btn = get('f_btn');

                f_nod.configure({
                    submit: '#f_btn',
                    disableSubmit: true
                });

                setValue(f, 'foo');

                expect(f_btn.disabled === true, 'Can disable submit button when there are errors');

                setValue(f, 'fo');

                expect(f_btn.disabled === false, 'Enables submit button when no more errors');

                // We're done
                removeElement(f.parentNode);
            })();
        </script>




        <form action=''>
            <input id='g' type='text'>
        </form>

        <script>
            (function () {
                var g_nod = nod();

                g_nod.add({
                    selector: '#g',
                    validate: function (callback, value) { callback(+value % 2 === 0); },
                    errorMessage: ERROR_MSG
                });

                var g = get('g');

                setValue(g, '4');

                setTimeout(function () {
                    expect(isValid(g), 'Custom checker function works');
                }, 800);

                // We're done
                removeElement(g.parentNode);
            })();
        </script>





        <form action=''>
            <div><input id='ha' type='text'></div>
            <div><input id='hb' type='text'></div>
            <div><input id='hc' type='text'></div>
            <div><input id='hd' type='text'></div>
            <div><input id='he' type='text'></div>
            <div><input id='hf' type='text'></div>
            <div><input id='hg' type='text'></div>
            <div><input id='hh' type='text'></div>
            <div><input id='hi' type='text'></div>
            <div><input id='hj' type='text'></div>
            <div><input id='hk' type='text'></div>
            <div><input id='hl' type='text'></div>
            <div><input id='hm' type='checkbox'></div>
            <div><input id='hn' type='text'></div>
            <div><input id='ho' type='text'></div>
            <div><input id='hp' type='text'></div>
            <div><input id='hq' type='text'></div>
            <div><input id='hr' type='text'></div>
        </form>

        <script>
            (function () {
                var h_nod = nod();

                h_nod.configure('delay', 0);

                h_nod.add([{
                    selector: '#ha',
                    validate: 'presence',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hb',
                    validate: 'exact:foo',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hc',
                    validate: 'not:foo',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hd',
                    validate: 'min-length:3',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#he',
                    validate: 'max-length:3',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hf',
                    validate: 'between-length:2:4',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hp',
                    validate: 'exact-length:3',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hg',
                    validate: 'min-number:3',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hh',
                    validate: 'max-number:3',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hi',
                    validate: 'between-number:3:6',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hj',
                    validate: 'integer',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hk',
                    validate: 'float',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hl',
                    validate: 'same-as:#hk',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hm',
                    validate: 'checked',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hn',
                    validate: /foo/,
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#ho',
                    validate: 'email',
                    errorMessage: ERROR_MSG
                }, {
                    selector: '#hq',
                    validate: 'email',
                    errorMessage: 'Not an email'
                }, {
                    selector: '#hq',
                    validate: 'max-length:8',
                    errorMessage: 'too long'
                }, {
                    selector: '#hr',
                    validate: ['email', 'max-length:8'],
                    errorMessage: ['Not an email', 'too long']
                }]);

                var ha = get('ha'),
                    hc = get('hc'),
                    hd = get('hd'),
                    he = get('he'),
                    hf = get('hf'),
                    hg = get('hg'),
                    hh = get('hh'),
                    hi = get('hi'),
                    hj = get('hj'),
                    hk = get('hk'),
                    hl = get('hl'),
                    hm = get('hm'),
                    hn = get('hn'),
                    ho = get('ho'),
                    hp = get('hp'),
                    hq = get('hq');

                setValue(ha, 'foo');
                expect(isValid(ha), 'Check - `presence`');

                setValue(hb, 'foo');
                expect(isValid(hb), 'Check - `exact`');

                setValue(hc, 'foo');
                expect(isInvalid(hc), 'Check - `not`');

                setValue(hd, 'foo');
                expect(isValid(hd), 'Check - `min-length`');

                setValue(he, 'foo');
                expect(isValid(he), 'Check - `max-length`');

                setValue(hf, 'foo');
                expect(isValid(hf), 'Check - `between-length`');

                setValue(hg, '3');
                expect(isValid(hg), 'Check - `min-number`');

                setValue(hh, '3');
                expect(isValid(hh), 'Check - `max-number`');

                setValue(hi, '3');
                expect(isValid(hi), 'Check - `between-number`');

                setValue(hj, '3');
                expect(isValid(hj), 'Check - `integer`');
                setValue(hj, '3.5');
                expect(isInvalid(hj), 'Check - `integer` (2nd check)');

                setValue(hk, '3.4');
                expect(isValid(hk), 'Check - `float`');

                setValue(hl, '3.4');
                expect(isValid(hl), 'Check - `same-as`');

                hm.checked = true;
                trigger(hm, 'change');
                expect(isValid(hm), 'Check - `checked`');

                setValue(hn, 'foo');
                expect(isValid(hn), 'Check - `regex`');

                setValue(ho, 'some@email.com');
                expect(isValid(ho), 'Check - `email`');
                setValue(ho, 'some@.com');
                expect(isInvalid(ho), 'Check - `email` (2nd check)');

                setValue(hp, 'fo');
                expect(isInvalid(hp), 'Check - `exact-length`');
                setValue(hp, 'foo');
                expect(isValid(hp), 'Check - `exact-length` (2nd check)');


                setValue(hq, 'f@b.com');
                expect(isValid(hq), 'Multiple checks on one field. #1');

                setValue(hq, 'f.com');
                expect(isInvalid(hq), 'Multiple checks on one field. #2');
                expect(hq.parentNode.lastChild.innerHTML === 'Not an email', 'Multiple checks on one field. #3 (showing correct error msg)');

                setValue(hq, 'foo@bar.com');
                expect(hq.parentNode.lastChild.innerHTML === 'too long', 'Multiple checks on one field. #4 (showing other correct error msg)');


                setValue(hr, 'f@b.com');
                expect(isValid(hr), 'Multiple checks on one field via an array. #1');

                setValue(hr, 'f.com');
                expect(isInvalid(hr), 'Multiple checks on one field via an array. #2');
                expect(hr.parentNode.lastChild.innerHTML === 'Not an email', 'Multiple checks on one field via an array. #3 (showing correct error msg)');

                setValue(hr, 'foo@bar.com');
                expect(hr.parentNode.lastChild.innerHTML === 'too long', 'Multiple checks on one field via an array. #4 (showing other correct error msg)');

                // We're done
                removeElement(ha.parentNode.parentNode);
            })();
        </script>



        <form action=''>
            <span id='i-error-message-here' class='my-class'></span>
            <input id='i' type='text'>
        </form>

        <script>
            (function () {
                var i_nod = nod();

                i_nod.configure('delay', 0);

                i_nod.add({
                    selector: '#i',
                    validate: 'presence',
                    errorMessage: 'custom error span?',
                    messageContainer: '#i-error-message-here'
                });

                var i = get('i'),
                    i_msg = get('i-error-message-here');

                setValue(i, '');

                expect(i_msg.innerHTML === 'custom error span?', 'Custom error container is used for message');

                expect(hasClass('my-class', i_msg), 'Custom error container maintains its classes');

                removeElement(i.parentNode);
            })();
        </script>
    </body>
</html>
